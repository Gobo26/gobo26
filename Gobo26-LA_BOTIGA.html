<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>La Botiga - Gobo26</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; overflow: hidden; }
        body {
            font-family: 'Montserrat', sans-serif;
            background: #f1f5f9;
            color: #334155;
            display: flex;
            flex-direction: column;
            height: 100dvh;
        }

        /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
        header {
            background: #1e293b;
            color: white;
            padding: 0 12px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
            position: relative;
        }
        .header-logo { display:flex; align-items:center; gap:8px; text-decoration:none; color:white; z-index:1; }
        .header-title {
            position:absolute; left:50%; transform:translateX(-50%);
            font-size:1rem; font-weight:800; white-space:nowrap; pointer-events:none;
        }
        .header-right { display:flex; align-items:center; gap:8px; z-index:1; }
        .header-score {
            display:flex; align-items:center; gap:5px;
            background:rgba(255,255,255,0.12);
            padding:4px 10px; border-radius:20px;
            font-size:0.8rem; font-weight:700;
        }
        .btn-ajuda {
            background:rgba(255,255,255,0.15);
            border:none; border-radius:50%;
            width:30px; height:30px;
            color:white; font-size:1rem; font-weight:900;
            cursor:pointer; display:flex; align-items:center; justify-content:center;
            -webkit-tap-highlight-color:transparent;
            transition: background 0.2s;
            flex-shrink:0;
        }
        .btn-ajuda:hover { background:rgba(255,255,255,0.28); }

        /* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
        main {
            flex:1; max-width:520px; width:100%;
            margin:0 auto; padding:6px 10px 4px;
            display:flex; flex-direction:column; gap:6px;
            overflow:hidden;
        }

        /* ‚îÄ‚îÄ PANTALLA INICIAL ‚îÄ‚îÄ */
        #pantalla-inici {
            display:flex; flex-direction:column;
            align-items:center; justify-content:center;
            gap:14px; flex:1; text-align:center;
            padding:10px;
        }
        .inici-logo {
            font-size:3.5rem; line-height:1;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.15));
        }
        .inici-titol { font-size:1.5rem; font-weight:900; color:#1e293b; }
        .inici-subtitol { font-size:0.82rem; font-weight:600; color:#64748b; line-height:1.5; max-width:320px; }
        .inici-record {
            background:white; border-radius:12px;
            padding:10px 20px; box-shadow:0 2px 8px rgba(0,0,0,0.08);
            font-size:0.8rem; font-weight:700; color:#64748b;
            display:flex; gap:20px;
        }
        .inici-record span { display:flex; flex-direction:column; align-items:center; gap:2px; }
        .inici-record strong { font-size:1.3rem; font-weight:900; color:#2563eb; }
        .btn-comecar {
            font-family:'Montserrat',sans-serif; font-weight:900;
            font-size:1.1rem; background:#2563eb; color:white;
            border:none; border-radius:14px;
            padding:16px 40px; cursor:pointer;
            box-shadow:0 5px 0 #1d4ed8;
            -webkit-tap-highlight-color:transparent;
            transition:transform 0.1s;
        }
        .btn-comecar:active { transform:translateY(5px); box-shadow:none; }

        /* ‚îÄ‚îÄ PANTALLA JOC ‚îÄ‚îÄ */
        #pantalla-joc { display:none; flex-direction:column; gap:6px; flex:1; overflow:hidden; }

        /* TAULER */
        .tauler {
            background:white; border-radius:12px;
            padding:8px 12px; box-shadow:0 2px 6px rgba(0,0,0,0.07);
            display:flex; gap:0;
        }
        .tauler-bloc { flex:1; display:flex; flex-direction:column; gap:1px; }
        .tauler-bloc+.tauler-bloc { border-left:1px solid #f1f5f9; padding-left:12px; margin-left:12px; }
        .tauler-label { font-size:0.6rem; font-weight:700; text-transform:uppercase; letter-spacing:0.7px; color:#94a3b8; }
        .tauler-valor { font-size:1.55rem; font-weight:900; color:#1e293b; line-height:1.1; }
        .tauler-val-verd { color:#16a34a; }

        /* PARANY */
        .parany-zona {
            background:#fef9c3; border:2px solid #eab308;
            border-radius:10px; padding:6px 10px;
            font-size:0.78rem; font-weight:700; color:#854d0e;
            text-align:center; display:none;
            animation:apareix 0.25s ease; line-height:1.3;
            flex-shrink:0;
        }
        .parany-zona.urgent { background:#fee2e2; border-color:#ef4444; color:#991b1b; }
        .parany-emoji { font-size:1rem; margin-right:4px; }
        .compte-enrere {
            display:inline-block; font-size:1.3rem; font-weight:900;
            color:#ef4444; margin-left:6px; min-width:28px; text-align:center;
        }
        .compte-enrere.curt { animation:parpelleig 0.5s infinite; }
        @keyframes parpelleig { 0%,100%{opacity:1;} 50%{opacity:0.2;} }

        /* META */
        .meta-zona { display:flex; align-items:center; justify-content:space-between; padding:0 1px; }
        .pips { display:flex; gap:4px; }
        .pip { width:7px; height:7px; border-radius:50%; background:#cbd5e1; transition:background 0.3s; }
        .pip.actiu { background:#2563eb; }
        .nivell-nom { font-size:0.62rem; font-weight:700; color:#64748b; text-transform:uppercase; letter-spacing:0.8px; }
        .ratxa-zona { font-size:0.72rem; font-weight:700; color:#64748b; }

        /* CANVI */
        .zona-canvi {
            background:white; border-radius:12px;
            padding:6px 12px 8px; box-shadow:0 2px 6px rgba(0,0,0,0.07);
            text-align:center; border:2px solid #e2e8f0;
            transition:border-color 0.25s; flex-shrink:0;
        }
        .zona-canvi.sobrepassa { border-color:#ef4444; }
        .canvi-etiqueta { font-size:0.58rem; font-weight:700; text-transform:uppercase; letter-spacing:0.8px; color:#94a3b8; }
        .canvi-valor { font-size:2rem; font-weight:900; color:#334155; line-height:1.1; transition:color 0.25s; }
        .canvi-valor.sobrepassa { color:#ef4444; }

        /* INTENTS */
        .intent-zona { display:flex; justify-content:center; gap:8px; }
        .intent-pip { width:10px; height:10px; border-radius:50%; background:#e2e8f0; transition:background 0.3s; }
        .intent-pip.usat { background:#ef4444; }

        /* GRID MONEDES */
        .zona-caixa { display:grid; grid-template-columns:repeat(6,1fr); gap:5px; flex-shrink:0; }
        .moneda-boto {
            font-family:'Montserrat',sans-serif;
            border:none; border-radius:8px;
            padding:4px 2px; cursor:pointer;
            min-height:60px; display:flex; flex-direction:column;
            align-items:center; justify-content:center;
            gap:2px; background:transparent;
            transition:opacity 0.3s;
            -webkit-tap-highlight-color:transparent;
            position:relative;
        }
        .moneda-boto svg { width:38px; height:38px; display:block; }
        .moneda-boto.bitllet svg { width:52px; height:26px; }
        .moneda-boto .etiq { font-size:0.52rem; font-weight:800; text-transform:uppercase; letter-spacing:0.3px; color:#475569; line-height:1; }
        .moneda-boto:active { transform:scale(0.9); }
        .zona-caixa.desactivada .moneda-boto { opacity:0.3; pointer-events:none; }
        .moneda-boto.bloquejada { opacity:0.22!important; pointer-events:none!important; }
        .moneda-boto.bloquejada::after { content:'üö´'; position:absolute; top:2px; right:2px; font-size:0.65rem; }

        /* ACCIONS */
        .zona-accions { display:grid; grid-template-columns:1fr 1fr; gap:7px; flex-shrink:0; }
        .boto-accio {
            font-family:'Montserrat',sans-serif;
            font-weight:800; font-size:0.9rem;
            border:none; border-radius:10px;
            padding:10px; cursor:pointer; min-height:44px;
            -webkit-tap-highlight-color:transparent;
        }
        .boto-accio:active { transform:translateY(2px); box-shadow:none!important; }
        .boto-corregir { background:#fee2e2; color:#991b1b; box-shadow:0 3px 0 #ef4444; }
        .boto-cobrar   { background:#2563eb; color:white;   box-shadow:0 3px 0 #1d4ed8; }
        .boto-cobrar:disabled { background:#94a3b8; box-shadow:0 3px 0 #64748b; cursor:not-allowed; transform:none; }

        /* FEEDBACK */
        .feedback-zona {
            border-radius:10px; padding:8px 12px;
            font-size:0.88rem; font-weight:700;
            text-align:center; display:none;
            animation:apareix 0.2s ease; line-height:1.4;
            flex-shrink:0;
        }
        @keyframes apareix { from{opacity:0;transform:scale(0.95);} to{opacity:1;transform:scale(1);} }
        .feedback-zona.correcte { background:#dcfce7; color:#14532d; border:2px solid #22c55e; }
        .feedback-zona.error    { background:#fee2e2; color:#991b1b; border:2px solid #ef4444; }

        /* BOTO SEGUENT */
        .boto-seguent {
            font-family:'Montserrat',sans-serif;
            font-weight:800; font-size:0.95rem;
            background:#2563eb; color:white;
            border:none; border-radius:10px;
            padding:12px; cursor:pointer; width:100%;
            min-height:44px; box-shadow:0 3px 0 #1d4ed8;
            display:none; animation:apareix 0.2s ease;
            -webkit-tap-highlight-color:transparent;
            flex-shrink:0;
        }
        .boto-seguent:active { transform:translateY(3px); box-shadow:none; }
        .boto-inici { background:#334155; box-shadow:0 3px 0 #1e293b; }

        /* ‚îÄ‚îÄ MODAL INSTRUCCIONS ‚îÄ‚îÄ */
        .modal-overlay {
            position:fixed; inset:0;
            background:rgba(0,0,0,0.55);
            z-index:200;
            display:none; align-items:center; justify-content:center;
            padding:16px;
            animation:apareix 0.2s ease;
        }
        .modal-overlay.obert { display:flex; }
        .modal-caixa {
            background:white; border-radius:18px;
            max-width:420px; width:100%;
            max-height:90dvh; overflow-y:auto;
            padding:20px 18px 18px;
            box-shadow:0 20px 60px rgba(0,0,0,0.3);
        }
        .modal-cap {
            display:flex; align-items:center; justify-content:space-between;
            margin-bottom:14px;
        }
        .modal-titol { font-size:1.05rem; font-weight:900; color:#1e293b; }
        .modal-tancar {
            background:#f1f5f9; border:none; border-radius:50%;
            width:30px; height:30px; font-size:1rem;
            cursor:pointer; display:flex; align-items:center; justify-content:center;
            color:#64748b; font-weight:900;
        }
        .modal-seccio { margin-bottom:12px; }
        .modal-seccio h3 {
            font-size:0.72rem; font-weight:800;
            text-transform:uppercase; letter-spacing:0.8px;
            color:#2563eb; margin-bottom:6px;
        }
        .modal-seccio p, .modal-seccio li {
            font-size:0.8rem; line-height:1.55; color:#475569; font-weight:600;
        }
        .modal-seccio ul { padding-left:16px; }
        .modal-seccio li { margin-bottom:4px; }
        .modal-divider { height:1px; background:#f1f5f9; margin:12px 0; }
        .nivell-taula { width:100%; border-collapse:collapse; margin-top:6px; }
        .nivell-taula td { font-size:0.75rem; font-weight:600; color:#475569; padding:4px 6px; }
        .nivell-taula tr:nth-child(odd) td { background:#f8fafc; border-radius:6px; }

        /* ‚îÄ‚îÄ CONFETTI ‚îÄ‚îÄ */
        #confetti-canvas { position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:100; }

        @keyframes salteta { 0%,100%{transform:scale(1);} 50%{transform:scale(1.08);} }
        .salta { animation:salteta 0.35s ease 2; }
        @keyframes tremola { 0%,100%{transform:translateX(0);} 25%{transform:translateX(-5px);} 75%{transform:translateX(5px);} }
        .tremola { animation:tremola 0.1s ease 4; }

        footer {
            background:#1e293b; color:#94a3b8;
            text-align:center; padding:6px;
            font-size:0.65rem; font-weight:600; flex-shrink:0;
        }
        footer a { color:#94a3b8; text-decoration:none; }
    </style>
</head>
<body>

<canvas id="confetti-canvas"></canvas>

<!-- MODAL INSTRUCCIONS -->
<div class="modal-overlay" id="modal-instruccions">
    <div class="modal-caixa">
        <div class="modal-cap">
            <span class="modal-titol">üõí Com es juga</span>
            <button class="modal-tancar" onclick="tancarModal()">‚úï</button>
        </div>

        <div class="modal-seccio">
            <h3>L'objectiu</h3>
            <p>Es mostra el preu d'una compra i el bitllet amb qu√® paga el client. Tu has de calcular mentalment el canvi i donar-lo prement les monedes i bitllets correctes.</p>
        </div>

        <div class="modal-divider"></div>

        <div class="modal-seccio">
            <h3>Com jugar</h3>
            <ul>
                <li>Prem les monedes i bitllets per compondre el canvi.</li>
                <li>Si t'equivoques, prem <strong>Corregir</strong> per tornar a zero.</li>
                <li>Quan tinguis l'import exacte, prem <strong>Cobrar</strong>.</li>
                <li>Tens <strong>2 intents</strong> per encertar. Al segon error tornes a la pantalla inicial.</li>
            </ul>
        </div>

        <div class="modal-divider"></div>

        <div class="modal-seccio">
            <h3>Paranys</h3>
            <ul>
                <li>‚ö†Ô∏è De vegades no tindr√†s certes monedes o bitllets (estan bloquejats).</li>
                <li>‚è±Ô∏è De vegades el client t√© pressa: haur√†s de cobrar dins un temps limitat.</li>
                <li>Si s'esgota el temps, el client marxa i perds la ratxa.</li>
            </ul>
        </div>

        <div class="modal-divider"></div>

        <div class="modal-seccio">
            <h3>Nivells de dificultat</h3>
            <table class="nivell-taula">
                <tr><td>üü¢ Principiant</td><td>0.03 ‚Äì 0.99 ‚Ç¨</td><td>bitllet 1-2 ‚Ç¨</td></tr>
                <tr><td>üîµ B√†sic</td><td>0.50 ‚Äì 4.95 ‚Ç¨</td><td>bitllet 5 ‚Ç¨</td></tr>
                <tr><td>üü° Mitj√†</td><td>1 ‚Äì 19.99 ‚Ç¨</td><td>bitllet 10-20 ‚Ç¨</td></tr>
                <tr><td>üü† Avan√ßat</td><td>5 ‚Äì 49.99 ‚Ç¨</td><td>bitllet 20-50 ‚Ç¨</td></tr>
                <tr><td>üî¥ Expert</td><td>0.03 ‚Äì 99.99 ‚Ç¨</td><td>bitllet 50-100 ‚Ç¨</td></tr>
            </table>
            <p style="margin-top:8px;">El nivell puja autom√†ticament en encadenar vendes correctes. Un doble error et torna al principi.</p>
        </div>

        <div class="modal-divider"></div>

        <div class="modal-seccio">
            <h3>Ratxa i puntuaci√≥</h3>
            <ul>
                <li>Cada venda correcta suma a la ratxa üî•.</li>
                <li>El r√®cord de ratxa es guarda al dispositiu.</li>
                <li>Si t'equivoques dues vegades o s'esgota el temps, la ratxa es perd.</li>
            </ul>
        </div>
    </div>
</div>

<header>
    <a class="header-logo" href="https://ja.cat/appgobo" target="_self">
        <svg width="32" height="32" viewBox="0 0 40 46" fill="none">
            <path d="M20 1L38 11V33L20 43L2 33V11L20 1Z" fill="#2563eb" stroke="#60a5fa" stroke-width="1.5"/>
            <text x="20" y="23" text-anchor="middle" fill="white" font-family="Montserrat,sans-serif" font-weight="900" font-size="9">GOBO</text>
            <text x="20" y="33" text-anchor="middle" fill="#93c5fd" font-family="Montserrat,sans-serif" font-weight="900" font-size="7">26</text>
        </svg>
    </a>
    <span class="header-title">La Botiga</span>
    <div class="header-right">
        <div class="header-score">üõí <span id="vendes-avui">0</span></div>
        <button class="btn-ajuda" onclick="obrirModal()" aria-label="Instruccions">?</button>
    </div>
</header>

<main>

    <!-- PANTALLA INICIAL -->
    <div id="pantalla-inici">
        <div class="inici-logo">üõí</div>
        <div class="inici-titol">La Botiga</div>
        <div class="inici-subtitol">Practica el c√†lcul mental del canvi. El client et d√≥na un bitllet ‚Äî tu has de tornar l'import exacte.</div>
        <div class="inici-record">
            <span><strong id="inici-vendes">0</strong>Vendes</span>
            <span><strong id="inici-record">0</strong>R√®cord ratxa</span>
            <span><strong id="inici-nivell">üü¢</strong>Nivell</span>
        </div>
        <button class="btn-comecar" onclick="comecar()">Comen√ßa ‚Üí</button>
    </div>

    <!-- PANTALLA JOC -->
    <div id="pantalla-joc">

        <div class="tauler">
            <div class="tauler-bloc">
                <div class="tauler-label">La compra val</div>
                <div class="tauler-valor" id="preu-compra">‚Äì</div>
            </div>
            <div class="tauler-bloc">
                <div class="tauler-label">El client paga</div>
                <div class="tauler-valor tauler-val-verd" id="pagament-client">‚Äì</div>
            </div>
        </div>

        <div class="parany-zona" id="parany-zona">
            <span class="parany-emoji" id="parany-emoji">‚ö†Ô∏è</span>
            <span id="parany-text"></span>
            <span class="compte-enrere" id="compte-enrere" style="display:none"></span>
        </div>

        <div class="meta-zona">
            <div class="pips" id="pips-nivell"></div>
            <span class="nivell-nom" id="nivell-nom">‚Äì</span>
            <span class="ratxa-zona" id="ratxa-text"></span>
        </div>

        <div class="zona-canvi" id="zona-canvi">
            <div class="canvi-etiqueta">Quin canvi has de donar?</div>
            <div class="canvi-valor" id="canvi-acumulat">0.00 ‚Ç¨</div>
        </div>

        <div class="intent-zona">
            <div class="intent-pip" id="pip-1"></div>
            <div class="intent-pip" id="pip-2"></div>
        </div>

        <div class="zona-caixa" id="zona-caixa">
            <button class="moneda-boto" id="btn-001" onclick="afegir(0.01)">
                <svg viewBox="0 0 40 40"><defs><radialGradient id="g1c" cx="35%" cy="30%"><stop offset="0%" stop-color="#e8a850"/><stop offset="50%" stop-color="#c47820"/><stop offset="100%" stop-color="#8b4c00"/></radialGradient></defs>
                <circle cx="20" cy="20" r="19" fill="url(#g1c)" stroke="#7a3800" stroke-width="0.8"/>
                <circle cx="20" cy="20" r="15" fill="none" stroke="rgba(255,200,80,0.35)" stroke-width="0.6"/>
                <text x="20" y="25" text-anchor="middle" fill="#fff8e0" font-family="Montserrat,sans-serif" font-weight="900" font-size="13">1</text></svg>
                <span class="etiq">c√®ntim</span>
            </button>
            <button class="moneda-boto" id="btn-002" onclick="afegir(0.02)">
                <svg viewBox="0 0 40 40"><defs><radialGradient id="g2c" cx="35%" cy="30%"><stop offset="0%" stop-color="#e8a850"/><stop offset="50%" stop-color="#c47820"/><stop offset="100%" stop-color="#8b4c00"/></radialGradient></defs>
                <circle cx="20" cy="20" r="19" fill="url(#g2c)" stroke="#7a3800" stroke-width="0.8"/>
                <circle cx="20" cy="20" r="15" fill="none" stroke="rgba(255,200,80,0.35)" stroke-width="0.6"/>
                <text x="20" y="25" text-anchor="middle" fill="#fff8e0" font-family="Montserrat,sans-serif" font-weight="900" font-size="13">2</text></svg>
                <span class="etiq">c√®ntims</span>
            </button>
            <button class="moneda-boto" id="btn-005" onclick="afegir(0.05)">
                <svg viewBox="0 0 40 40"><defs><radialGradient id="g5c" cx="35%" cy="30%"><stop offset="0%" stop-color="#f0b060"/><stop offset="50%" stop-color="#d4601a"/><stop offset="100%" stop-color="#8b3000"/></radialGradient></defs>
                <circle cx="20" cy="20" r="19" fill="url(#g5c)" stroke="#7a2800" stroke-width="0.8"/>
                <circle cx="20" cy="20" r="15" fill="none" stroke="rgba(255,180,80,0.35)" stroke-width="0.6"/>
                <text x="20" y="25" text-anchor="middle" fill="#fff0d0" font-family="Montserrat,sans-serif" font-weight="900" font-size="13">5</text></svg>
                <span class="etiq">c√®ntims</span>
            </button>
            <button class="moneda-boto" id="btn-010" onclick="afegir(0.10)">
                <svg viewBox="0 0 40 40"><defs><radialGradient id="g10c" cx="35%" cy="30%"><stop offset="0%" stop-color="#f5c842"/><stop offset="50%" stop-color="#d4940e"/><stop offset="100%" stop-color="#8b5c00"/></radialGradient></defs>
                <circle cx="20" cy="20" r="19" fill="url(#g10c)" stroke="#7a4800" stroke-width="0.8"/>
                <circle cx="20" cy="20" r="14.5" fill="none" stroke="rgba(255,220,80,0.4)" stroke-width="0.7"/>
                <text x="20" y="25" text-anchor="middle" fill="#fff8e0" font-family="Montserrat,sans-serif" font-weight="900" font-size="11">10</text></svg>
                <span class="etiq">c√®ntims</span>
            </button>
            <button class="moneda-boto" id="btn-020" onclick="afegir(0.20)">
                <svg viewBox="0 0 40 40"><defs><radialGradient id="g20c" cx="35%" cy="30%"><stop offset="0%" stop-color="#f7d060"/><stop offset="50%" stop-color="#d4a010"/><stop offset="100%" stop-color="#8b6000"/></radialGradient></defs>
                <circle cx="20" cy="20" r="19" fill="url(#g20c)" stroke="#7a5000" stroke-width="0.8"/>
                <circle cx="20" cy="20" r="13" fill="none" stroke="rgba(255,230,80,0.45)" stroke-width="0.7"/>
                <text x="20" y="25" text-anchor="middle" fill="#fff8e0" font-family="Montserrat,sans-serif" font-weight="900" font-size="11">20</text></svg>
                <span class="etiq">c√®ntims</span>
            </button>
            <button class="moneda-boto" id="btn-050" onclick="afegir(0.50)">
                <svg viewBox="0 0 40 40"><defs><radialGradient id="g50c" cx="35%" cy="30%"><stop offset="0%" stop-color="#ffe070"/><stop offset="50%" stop-color="#d4aa00"/><stop offset="100%" stop-color="#907000"/></radialGradient></defs>
                <circle cx="20" cy="20" r="19" fill="url(#g50c)" stroke="#806000" stroke-width="0.8"/>
                <circle cx="20" cy="20" r="14" fill="none" stroke="rgba(255,240,100,0.5)" stroke-width="0.7"/>
                <text x="20" y="25" text-anchor="middle" fill="#3a2800" font-family="Montserrat,sans-serif" font-weight="900" font-size="11">50</text></svg>
                <span class="etiq">c√®ntims</span>
            </button>
            <button class="moneda-boto" id="btn-100" onclick="afegir(1)">
                <svg viewBox="0 0 40 40"><defs>
                <radialGradient id="g1e_ext" cx="35%" cy="30%"><stop offset="0%" stop-color="#f0d060"/><stop offset="100%" stop-color="#a07800"/></radialGradient>
                <radialGradient id="g1e_int" cx="40%" cy="35%"><stop offset="0%" stop-color="#e8e8e8"/><stop offset="100%" stop-color="#909090"/></radialGradient>
                </defs>
                <circle cx="20" cy="20" r="19" fill="url(#g1e_ext)" stroke="#806000" stroke-width="0.8"/>
                <circle cx="20" cy="20" r="12" fill="url(#g1e_int)" stroke="#707070" stroke-width="0.6"/>
                <text x="20" y="25" text-anchor="middle" fill="#2a2a2a" font-family="Montserrat,sans-serif" font-weight="900" font-size="13">1‚Ç¨</text></svg>
                <span class="etiq">moneda</span>
            </button>
            <button class="moneda-boto" id="btn-200" onclick="afegir(2)">
                <svg viewBox="0 0 40 40"><defs>
                <radialGradient id="g2e_ext" cx="35%" cy="30%"><stop offset="0%" stop-color="#d8d8d8"/><stop offset="100%" stop-color="#888888"/></radialGradient>
                <radialGradient id="g2e_int" cx="40%" cy="35%"><stop offset="0%" stop-color="#ffe060"/><stop offset="100%" stop-color="#a07800"/></radialGradient>
                </defs>
                <circle cx="20" cy="20" r="19" fill="url(#g2e_ext)" stroke="#707070" stroke-width="0.8"/>
                <circle cx="20" cy="20" r="12" fill="url(#g2e_int)" stroke="#907000" stroke-width="0.6"/>
                <text x="20" y="25" text-anchor="middle" fill="#1a1a1a" font-family="Montserrat,sans-serif" font-weight="900" font-size="12">2‚Ç¨</text></svg>
                <span class="etiq">moneda</span>
            </button>
            <button class="moneda-boto bitllet" id="btn-500" onclick="afegir(5)">
                <svg viewBox="0 0 60 30"><defs><linearGradient id="b5" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#b8c8d8"/><stop offset="50%" stop-color="#8aacca"/><stop offset="100%" stop-color="#6090b8"/></linearGradient></defs>
                <rect x="1" y="1" width="58" height="28" rx="3" fill="url(#b5)" stroke="#4a7a9e" stroke-width="0.8"/>
                <rect x="3" y="3" width="54" height="24" rx="2" fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="0.5"/>
                <text x="30" y="20" text-anchor="middle" fill="white" font-family="Montserrat,sans-serif" font-weight="900" font-size="13" opacity="0.95">5 ‚Ç¨</text></svg>
                <span class="etiq">bitllet</span>
            </button>
            <button class="moneda-boto bitllet" id="btn-1000" onclick="afegir(10)">
                <svg viewBox="0 0 60 30"><defs><linearGradient id="b10" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#e8b090"/><stop offset="50%" stop-color="#d08060"/><stop offset="100%" stop-color="#b06030"/></linearGradient></defs>
                <rect x="1" y="1" width="58" height="28" rx="3" fill="url(#b10)" stroke="#904020" stroke-width="0.8"/>
                <rect x="3" y="3" width="54" height="24" rx="2" fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="0.5"/>
                <text x="30" y="20" text-anchor="middle" fill="white" font-family="Montserrat,sans-serif" font-weight="900" font-size="13" opacity="0.95">10 ‚Ç¨</text></svg>
                <span class="etiq">bitllet</span>
            </button>
            <button class="moneda-boto bitllet" id="btn-2000" onclick="afegir(20)">
                <svg viewBox="0 0 60 30"><defs><linearGradient id="b20" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#90b8e0"/><stop offset="50%" stop-color="#5090d0"/><stop offset="100%" stop-color="#2060a8"/></linearGradient></defs>
                <rect x="1" y="1" width="58" height="28" rx="3" fill="url(#b20)" stroke="#104080" stroke-width="0.8"/>
                <rect x="3" y="3" width="54" height="24" rx="2" fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="0.5"/>
                <text x="30" y="20" text-anchor="middle" fill="white" font-family="Montserrat,sans-serif" font-weight="900" font-size="13" opacity="0.95">20 ‚Ç¨</text></svg>
                <span class="etiq">bitllet</span>
            </button>
            <button class="moneda-boto bitllet" id="btn-5000" onclick="afegir(50)">
                <svg viewBox="0 0 60 30"><defs><linearGradient id="b50" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#ffd080"/><stop offset="50%" stop-color="#f0a030"/><stop offset="100%" stop-color="#c06800"/></linearGradient></defs>
                <rect x="1" y="1" width="58" height="28" rx="3" fill="url(#b50)" stroke="#a05000" stroke-width="0.8"/>
                <rect x="3" y="3" width="54" height="24" rx="2" fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="0.5"/>
                <text x="30" y="20" text-anchor="middle" fill="white" font-family="Montserrat,sans-serif" font-weight="900" font-size="13" opacity="0.95">50 ‚Ç¨</text></svg>
                <span class="etiq">bitllet</span>
            </button>
        </div>

        <div class="zona-accions">
            <button class="boto-accio boto-corregir" onclick="reiniciarCanvi()">‚úï Corregir</button>
            <button class="boto-accio boto-cobrar" id="boto-cobrar" onclick="comprovar()">‚úì Cobrar</button>
        </div>

        <div id="feedback" class="feedback-zona"></div>
        <button id="boto-seguent" class="boto-seguent" onclick="accioSeguent()">‚Äì</button>

    </div><!-- fi pantalla-joc -->

</main>

<footer>
    Una aplicaci√≥ de <a href="https://ja.cat/appgobo" target="_self">Gobo26</a>
</footer>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// √ÄUDIO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const audioCtx = (() => {
    try { return new (window.AudioContext || window.webkitAudioContext)(); } catch(e) { return null; }
})();
document.addEventListener('pointerdown', () => {
    if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
}, { once: true });

function tocarTirulit() {
    if (!audioCtx) return;
    const notes = [523.25, 659.25, 783.99, 659.25, 1046.50];
    const durs  = [0.12, 0.12, 0.12, 0.12, 0.25];
    let t = audioCtx.currentTime + 0.05;
    notes.forEach((freq, i) => {
        const osc = audioCtx.createOscillator(), gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.type = 'triangle'; osc.frequency.value = freq;
        gain.gain.setValueAtTime(0.3, t);
        gain.gain.exponentialRampToValueAtTime(0.001, t + durs[i]);
        osc.start(t); osc.stop(t + durs[i]);
        t += durs[i] + 0.02;
    });
}

function tocarClonc() {
    if (!audioCtx) return;
    const osc = audioCtx.createOscillator(), gain = audioCtx.createGain();
    osc.connect(gain); gain.connect(audioCtx.destination);
    osc.type = 'sawtooth';
    osc.frequency.setValueAtTime(200, audioCtx.currentTime);
    osc.frequency.exponentialRampToValueAtTime(55, audioCtx.currentTime + 0.2);
    gain.gain.setValueAtTime(0.4, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.28);
    osc.start(audioCtx.currentTime); osc.stop(audioCtx.currentTime + 0.3);
}

function tocarTic() {
    if (!audioCtx) return;
    const osc = audioCtx.createOscillator(), gain = audioCtx.createGain();
    osc.connect(gain); gain.connect(audioCtx.destination);
    osc.type = 'square'; osc.frequency.value = 880;
    gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.06);
    osc.start(audioCtx.currentTime); osc.stop(audioCtx.currentTime + 0.07);
}

function tocarGameOver() {
    if (!audioCtx) return;
    const notes = [392, 349.23, 311.13, 261.63];
    const durs  = [0.18, 0.18, 0.18, 0.38];
    let t = audioCtx.currentTime + 0.05;
    notes.forEach((freq, i) => {
        const osc = audioCtx.createOscillator(), gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.type = 'triangle'; osc.frequency.value = freq;
        gain.gain.setValueAtTime(0.28, t);
        gain.gain.exponentialRampToValueAtTime(0.001, t + durs[i]);
        osc.start(t); osc.stop(t + durs[i]);
        t += durs[i] + 0.03;
    });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFETTI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function llen√ßarConfetti() {
    const canvas = document.getElementById('confetti-canvas');
    const c = canvas.getContext('2d');
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    const colors = ['#2563eb','#22c55e','#f59e0b','#ef4444','#a855f7','#06b6d4','#f97316'];
    const parts = Array.from({length:120}, () => ({
        x: Math.random() * canvas.width, y: -10 - Math.random() * 100,
        vx: (Math.random()-.5)*4, vy: 2.5 + Math.random()*4,
        rot: Math.random()*360, vrot: (Math.random()-.5)*9,
        w: 8+Math.random()*8, h: 4+Math.random()*5,
        color: colors[Math.floor(Math.random()*colors.length)], alpha:1
    }));
    let tick=0, frame;
    function draw() {
        c.clearRect(0,0,canvas.width,canvas.height);
        parts.forEach(p => {
            p.x+=p.vx; p.y+=p.vy; p.rot+=p.vrot;
            if (tick>55) p.alpha=Math.max(0,p.alpha-0.018);
            c.save(); c.globalAlpha=p.alpha;
            c.translate(p.x,p.y); c.rotate(p.rot*Math.PI/180);
            c.fillStyle=p.color; c.fillRect(-p.w/2,-p.h/2,p.w,p.h);
            c.restore();
        });
        tick++;
        if (tick<140) frame=requestAnimationFrame(draw);
        else c.clearRect(0,0,canvas.width,canvas.height);
    }
    cancelAnimationFrame(frame); draw();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function obrirModal() {
    document.getElementById('modal-instruccions').classList.add('obert');
}
function tancarModal() {
    document.getElementById('modal-instruccions').classList.remove('obert');
}
document.getElementById('modal-instruccions').addEventListener('click', function(e) {
    if (e.target === this) tancarModal();
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ESTAT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let preu=0, pagat=0, canviUsuari=0, intent=1;
let vendes   = parseInt(localStorage.getItem('botiga_vendes')   || '0');
let ratxa    = parseInt(localStorage.getItem('botiga_ratxa')    || '0');
let maxRatxa = parseInt(localStorage.getItem('botiga_maxratxa') || '0');
let nivell   = parseInt(localStorage.getItem('botiga_nivell')   || '0');
let compteEnrereTId = null;
let paranyCurrent = null;
let accioSeguentFn = null;  // funci√≥ a executar en clicar "seguent"

const BOTONS = {
    'btn-001': 1, 'btn-002': 2, 'btn-005': 5, 'btn-010': 10,
    'btn-020': 20, 'btn-050': 50, 'btn-100': 100, 'btn-200': 200,
    'btn-500': 500, 'btn-1000': 1000, 'btn-2000': 2000, 'btn-5000': 5000
};

const NIVELLS = [
    { nom:'Principiant', emoji:'üü¢', minPreu:0.03, maxPreu:0.99,  bitllets:[1,2],    centsEspecials:null },
    { nom:'B√†sic',       emoji:'üîµ', minPreu:0.50, maxPreu:4.95,  bitllets:[5],      centsEspecials:[0,5,10,25,50,75,90,95] },
    { nom:'Mitj√†',       emoji:'üü°', minPreu:1,    maxPreu:19.99, bitllets:[10,20],  centsEspecials:[5,9,15,25,29,49,55,75,85,95,99] },
    { nom:'Avan√ßat',     emoji:'üü†', minPreu:5,    maxPreu:49.99, bitllets:[20,50],  centsEspecials:null },
    { nom:'Expert',      emoji:'üî¥', minPreu:0.03, maxPreu:99.99, bitllets:[50,100], centsEspecials:null },
];
const VENDES_PER_NIVELL = [4,4,5,5,999];

const TOTS_PARANYS = [
    { id:'no5c',      minNivell:0, prob:0.18, urgent:false, emoji:'üò§', text:()=>'No tens monedes de 5 c√®ntims.',          bloqueig:['btn-005'] },
    { id:'no10c',     minNivell:0, prob:0.15, urgent:false, emoji:'üò§', text:()=>'No tens monedes de 10 c√®ntims.',         bloqueig:['btn-010'] },
    { id:'no20c',     minNivell:1, prob:0.13, urgent:false, emoji:'üò§', text:()=>'No tens monedes de 20 c√®ntims.',         bloqueig:['btn-020'] },
    { id:'no50c',     minNivell:1, prob:0.12, urgent:false, emoji:'üò§', text:()=>'No tens monedes de 50 c√®ntims.',         bloqueig:['btn-050'] },
    { id:'no1e',      minNivell:1, prob:0.10, urgent:false, emoji:'üò§', text:()=>'No tens monedes d\'1 euro.',             bloqueig:['btn-100'] },
    { id:'no2e',      minNivell:2, prob:0.10, urgent:false, emoji:'üò§', text:()=>'No tens monedes de 2 euros.',            bloqueig:['btn-200'] },
    { id:'no5b',      minNivell:1, prob:0.14, urgent:false, emoji:'üò§', text:()=>'No et queden bitllets de 5 euros.',      bloqueig:['btn-500'] },
    { id:'no10b',     minNivell:2, prob:0.12, urgent:false, emoji:'üò§', text:()=>'No et queden bitllets de 10 euros.',     bloqueig:['btn-1000'] },
    { id:'no20b',     minNivell:3, prob:0.10, urgent:false, emoji:'üò§', text:()=>'No et queden bitllets de 20 euros.',     bloqueig:['btn-2000'] },
    { id:'noMenys10c',minNivell:1, prob:0.10, urgent:false, emoji:'ü´ô', text:()=>'La guardiola de c√®ntims petits √©s buida (1¬¢ i 2¬¢).', bloqueig:['btn-001','btn-002'] },
    { id:'noMenys5',  minNivell:1, prob:0.10, urgent:false, emoji:'ü™ô', text:()=>'No tens cap moneda de menys de 50 c√®ntims.', bloqueig:['btn-001','btn-002','btn-005','btn-010','btn-020'] },
    { id:'noMenys1e', minNivell:2, prob:0.08, urgent:false, emoji:'ü™ô', text:()=>'La caixa de monedes d\'1‚Ç¨ i 2‚Ç¨ √©s buida.', bloqueig:['btn-100','btn-200'] },
    { id:'pressa8',   minNivell:1, prob:0.18, urgent:true,  emoji:'‚è±Ô∏è', text:()=>'El client t√© pressa! Tens',              bloqueig:[], comptaEnrere:18 },
    { id:'pressa12',  minNivell:2, prob:0.15, urgent:true,  emoji:'‚è±Ô∏è', text:()=>'El client ha de marxar! Tens',           bloqueig:[], comptaEnrere:22 },
    { id:'pressa6',   minNivell:3, prob:0.14, urgent:true,  emoji:'üö®', text:()=>'Corre, corre! Tens',                     bloqueig:[], comptaEnrere:16 },
    { id:'comb1',     minNivell:2, prob:0.10, urgent:true,  emoji:'üò±', text:()=>'No tens 5¬¢ ni 10¬¢, i el client t√© pressa! Tens', bloqueig:['btn-005','btn-010'], comptaEnrere:20 },
    { id:'comb2',     minNivell:3, prob:0.08, urgent:true,  emoji:'üî•', text:()=>'No tens monedes de menys d\'1‚Ç¨ i a sobre tens poc temps! Tens', bloqueig:['btn-001','btn-002','btn-005','btn-010','btn-020','btn-050'], comptaEnrere:17 },
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PANTALLA INICIAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function actualitzarPantallaInici() {
    document.getElementById('inici-vendes').textContent = vendes;
    document.getElementById('inici-record').textContent = maxRatxa;
    document.getElementById('inici-nivell').textContent = NIVELLS[nivell].emoji + ' ' + NIVELLS[nivell].nom;
    document.getElementById('vendes-avui').textContent  = vendes;
}

function mostrarPantallaInici(missatgeGameOver) {
    aturarCompteEnrere();
    actualitzarPantallaInici();
    document.getElementById('pantalla-inici').style.display = 'flex';
    document.getElementById('pantalla-joc').style.display   = 'none';
    // Si ve d'un game over, mostrem un missatge breu a la pantalla d'inici
    if (missatgeGameOver) {
        const sub = document.querySelector('.inici-subtitol');
        sub.innerHTML = 'üò¨ Dues errades seguides. <br>El nivell torna a ' + NIVELLS[nivell].emoji + ' <strong>' + NIVELLS[nivell].nom + '</strong>.';
        setTimeout(() => {
            sub.innerHTML = 'Practica el c√†lcul mental del canvi. El client et d√≥na un bitllet ‚Äî tu has de tornar l\'import exacte.';
        }, 4000);
    }
}

function comecar() {
    document.getElementById('pantalla-inici').style.display = 'none';
    document.getElementById('pantalla-joc').style.display   = 'flex';
    novaVenda();
}

// Init
actualitzarPantallaInici();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NOVA VENDA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function novaVenda() {
    aturarCompteEnrere();
    paranyCurrent = null;
    accioSeguentFn = novaVenda;

    const n = NIVELLS[nivell];
    let p;
    if (n.centsEspecials) {
        const euros = Math.floor(n.minPreu + Math.random()*(n.maxPreu-n.minPreu));
        const cents = n.centsEspecials[Math.floor(Math.random()*n.centsEspecials.length)]/100;
        p = parseFloat((euros+cents).toFixed(2));
    } else {
        p = parseFloat((n.minPreu + Math.random()*(n.maxPreu-n.minPreu)).toFixed(2));
    }
    p = Math.max(n.minPreu, Math.min(n.maxPreu, p));
    preu = p;

    const bitlletsOrdenats = [...n.bitllets].sort((a,b)=>a-b);
    pagat = bitlletsOrdenats.find(b=>b>preu) || bitlletsOrdenats[bitlletsOrdenats.length-1];

    canviUsuari=0; intent=1;

    document.getElementById('preu-compra').textContent     = formatEur(preu);
    document.getElementById('pagament-client').textContent = formatEur(pagat);
    document.getElementById('canvi-acumulat').textContent  = '0.00 ‚Ç¨';
    document.getElementById('canvi-acumulat').className    = 'canvi-valor';
    document.getElementById('zona-canvi').className        = 'zona-canvi';
    document.getElementById('feedback').style.display      = 'none';
    document.getElementById('boto-seguent').style.display  = 'none';
    document.getElementById('zona-caixa').classList.remove('desactivada');
    document.getElementById('boto-cobrar').disabled        = false;
    document.getElementById('pip-1').className = 'intent-pip';
    document.getElementById('pip-2').className = 'intent-pip';
    Object.keys(BOTONS).forEach(id => {
        document.getElementById(id)?.classList.remove('bloquejada');
    });
    document.getElementById('parany-zona').style.display = 'none';
    document.getElementById('compte-enrere').style.display = 'none';

    actualitzarRatxa();
    aplicarParany();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PARANYS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function aplicarParany() {
    const freqBase = [0.22, 0.40, 0.58, 0.68, 0.75][nivell] || 0.65;
    if (Math.random() > freqBase) return;
    const possibles = TOTS_PARANYS.filter(p => p.minNivell <= nivell);
    const total = possibles.reduce((s,p) => s+p.prob, 0);
    let r = Math.random()*total, escollit = null;
    for (const p of possibles) { r -= p.prob; if (r<=0) { escollit=p; break; } }
    if (!escollit) escollit = possibles[possibles.length-1];

    const objectiu = Math.round((pagat-preu)*100);
    if (escollit.bloqueig?.length) {
        const valorsBloquejats = escollit.bloqueig.map(id => BOTONS[id]);
        if (!esResoluble(objectiu, valorsBloquejats)) return;
    }

    paranyCurrent = escollit;
    escollit.bloqueig?.forEach(id => document.getElementById(id)?.classList.add('bloquejada'));

    const zona = document.getElementById('parany-zona');
    document.getElementById('parany-emoji').textContent = escollit.emoji;
    const textRes = typeof escollit.text === 'function' ? escollit.text() : escollit.text;
    document.getElementById('parany-text').textContent = textRes;
    zona.className = 'parany-zona' + (escollit.urgent ? ' urgent' : '');

    const compteEl = document.getElementById('compte-enrere');
    if (escollit.comptaEnrere) {
        compteEl.style.display = 'inline-block';
        compteEl.className = 'compte-enrere';
        document.getElementById('parany-text').textContent = textRes + ' ';
        iniciarCompteEnrere(escollit.comptaEnrere);
    } else {
        compteEl.style.display = 'none';
    }
    zona.style.display = 'block';
}

function esResoluble(importCents, valorsBloquejats) {
    const disponibles = Object.values(BOTONS).filter(v => !valorsBloquejats.includes(v)).sort((a,b)=>b-a);
    if (!disponibles.length) return false;
    let resta = importCents;
    for (const v of disponibles) resta -= Math.floor(resta/v)*v;
    return resta === 0;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COMPTE ENRERE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function iniciarCompteEnrere(segons) {
    const compteEl = document.getElementById('compte-enrere');
    let restant = segons;
    compteEl.textContent = restant + 's';
    compteEnrereTId = setInterval(() => {
        restant--;
        compteEl.textContent = restant + 's';
        tocarTic();
        if (restant <= 3) compteEl.className = 'compte-enrere curt';
        if (restant <= 0) {
            aturarCompteEnrere();
            document.getElementById('zona-caixa').classList.add('desactivada');
            document.getElementById('boto-cobrar').disabled = true;
            tocarGameOver();
            if (navigator.vibrate) navigator.vibrate([100,50,100,50,100]);
            const feedback = document.getElementById('feedback');
            feedback.className = 'feedback-zona error';
            feedback.innerHTML = '‚åõ Temps esgotat! El client ha marxat.';
            feedback.style.display = 'block';
            ratxa = 0;
            localStorage.setItem('botiga_ratxa', 0);
            actualitzarRatxa();
            const btn = document.getElementById('boto-seguent');
            btn.textContent = 'Nou client ‚Üí';
            btn.className = 'boto-seguent';
            btn.style.display = 'block';
            accioSeguentFn = novaVenda;
        }
    }, 1000);
}

function aturarCompteEnrere() {
    if (compteEnrereTId) { clearInterval(compteEnrereTId); compteEnrereTId=null; }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AFEGIR / CORREGIR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function afegir(valor) {
    canviUsuari = parseFloat((canviUsuari+valor).toFixed(2));
    const el = document.getElementById('canvi-acumulat');
    const objectiu = parseFloat((pagat-preu).toFixed(2));
    el.textContent = formatEur(canviUsuari);
    if (canviUsuari > objectiu) {
        el.className = 'canvi-valor sobrepassa';
        document.getElementById('zona-canvi').className = 'zona-canvi sobrepassa';
    } else {
        el.className = 'canvi-valor';
        document.getElementById('zona-canvi').className = 'zona-canvi';
    }
    if (navigator.vibrate) navigator.vibrate(15);
}

function reiniciarCanvi() {
    canviUsuari = 0;
    document.getElementById('canvi-acumulat').textContent = '0.00 ‚Ç¨';
    document.getElementById('canvi-acumulat').className   = 'canvi-valor';
    document.getElementById('zona-canvi').className       = 'zona-canvi';
    document.getElementById('feedback').style.display     = 'none';
    if (navigator.vibrate) navigator.vibrate([15,20,15]);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COMPROVAR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function comprovar() {
    const objectiu = parseFloat((pagat-preu).toFixed(2));
    const feedback = document.getElementById('feedback');
    feedback.style.display = 'block';

    if (canviUsuari === objectiu) {
        // ‚úÖ CORRECTE
        aturarCompteEnrere();
        feedback.className = 'feedback-zona correcte';
        feedback.innerHTML = 'üéâ Perfecte! El canvi √©s correcte.';
        document.getElementById('zona-caixa').classList.add('desactivada');
        document.getElementById('boto-cobrar').disabled = true;
        tocarTirulit(); llen√ßarConfetti();
        if (navigator.vibrate) navigator.vibrate([30,50,100]);
        document.getElementById('canvi-acumulat').classList.add('salta');
        setTimeout(() => document.getElementById('canvi-acumulat').classList.remove('salta'), 800);

        vendes++; ratxa++;
        if (ratxa > maxRatxa) { maxRatxa=ratxa; localStorage.setItem('botiga_maxratxa', maxRatxa); }
        localStorage.setItem('botiga_vendes', vendes);
        localStorage.setItem('botiga_ratxa', ratxa);
        document.getElementById('vendes-avui').textContent = vendes;

        // Puja nivell?
        const threshold = VENDES_PER_NIVELL[nivell];
        const vendesTotals = vendes - NIVELLS.slice(0,nivell).reduce((acc,_,i)=>acc+VENDES_PER_NIVELL[i],0);
        if (nivell < NIVELLS.length-1 && vendesTotals >= threshold) {
            nivell++;
            localStorage.setItem('botiga_nivell', nivell);
            renderPips();
            feedback.innerHTML += '<br><small>‚¨ÜÔ∏è Nivell nou: '+NIVELLS[nivell].emoji+' '+NIVELLS[nivell].nom+'!</small>';
        }

        // Fites de ratxa
        if (ratxa === 5)  feedback.innerHTML += '<br><small>üî• Ratxa de 5! Molt b√©!</small>';
        if (ratxa === 10) feedback.innerHTML += '<br><small>üî•üî• Ratxa de 10! Impressionant!</small>';
        if (ratxa === 20) feedback.innerHTML += '<br><small>üî•üî•üî• Ratxa de 20! Ets un prodigi!</small>';

        const btn = document.getElementById('boto-seguent');
        btn.textContent = 'Seg√ºent client ‚Üí';
        btn.className = 'boto-seguent';
        btn.style.display = 'block';
        accioSeguentFn = novaVenda;

    } else {
        // ‚ùå ERROR
        tocarClonc();
        if (navigator.vibrate) navigator.vibrate([80,40,80]);
        document.getElementById('canvi-acumulat').classList.add('tremola');
        setTimeout(() => document.getElementById('canvi-acumulat').classList.remove('tremola'), 500);

        if (intent === 1) {
            // Primer error ‚Üí segona oportunitat
            document.getElementById('pip-1').className = 'intent-pip usat';
            feedback.className = 'feedback-zona error';
            feedback.innerHTML = '‚ùå Error en el canvi.<br><small>Torna-ho a intentar!</small>';
            intent = 2;
            setTimeout(() => reiniciarCanvi(), 1300);

        } else {
            // Segon error ‚Üí GAME OVER ‚Üí torna a pantalla inicial
            aturarCompteEnrere();
            document.getElementById('pip-2').className = 'intent-pip usat';

            // Baixar nivell (si no √©s el 0)
            const nivellAnterior = nivell;
            if (nivell > 0) {
                nivell = Math.max(0, nivell - 1);
                localStorage.setItem('botiga_nivell', nivell);
            }
            ratxa = 0;
            localStorage.setItem('botiga_ratxa', 0);

            tocarGameOver();
            if (navigator.vibrate) navigator.vibrate([100,50,100,50,100]);

            feedback.className = 'feedback-zona error';
            let missatgeFinal = '‚ùå Dues errades. El canvi correcte era <strong>'+formatEur(objectiu)+'</strong>.';
            if (nivellAnterior > 0) missatgeFinal += '<br><small>üìâ Baixes al nivell '+NIVELLS[nivell].emoji+' '+NIVELLS[nivell].nom+'</small>';
            feedback.innerHTML = missatgeFinal;
            document.getElementById('zona-caixa').classList.add('desactivada');
            document.getElementById('boto-cobrar').disabled = true;

            renderPips();
            actualitzarRatxa();

            const btn = document.getElementById('boto-seguent');
            btn.textContent = '‚Ü© Torna a l\'inici';
            btn.className = 'boto-seguent boto-inici';
            btn.style.display = 'block';
            accioSeguentFn = () => mostrarPantallaInici(true);
        }
    }
}

function accioSeguent() {
    if (accioSeguentFn) accioSeguentFn();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function formatEur(val) { return parseFloat(val).toFixed(2) + ' ‚Ç¨'; }

function renderPips() {
    const cont = document.getElementById('pips-nivell');
    const nomEl = document.getElementById('nivell-nom');
    cont.innerHTML = '';
    NIVELLS.forEach((n,i) => {
        const pip = document.createElement('div');
        pip.className = 'pip' + (i<=nivell ? ' actiu' : '');
        cont.appendChild(pip);
    });
    nomEl.textContent = NIVELLS[nivell].emoji+' '+NIVELLS[nivell].nom;
}

function actualitzarRatxa() {
    const el = document.getElementById('ratxa-text');
    if (ratxa >= 10)     el.textContent = 'üî•üî•üî• Ratxa '+ratxa;
    else if (ratxa >= 5) el.textContent = 'üî•üî• Ratxa '+ratxa;
    else if (ratxa >= 2) el.textContent = 'üî• Ratxa '+ratxa;
    else                 el.textContent = '';
}

renderPips();
</script>
</body>
</html>
